# üìä PostgreSQL Stats Collector

[![Version](https://img.shields.io/badge/version-2.1-blue.svg)](https://github.com/wobujidao/PostgreSQL-Activity-Monitor/tree/main/stats_db)
[![PostgreSQL](https://img.shields.io/badge/PostgreSQL-14+-blue.svg)](https://www.postgresql.org/)
[![License](https://img.shields.io/badge/license-MIT-green.svg)](../LICENSE)

## üìã –û–ø–∏—Å–∞–Ω–∏–µ

**PostgreSQL Stats Collector** ‚Äî —ç—Ç–æ –Ω–∞–±–æ—Ä —Å–∫—Ä–∏–ø—Ç–æ–≤ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–±–æ—Ä–∞ –∏ —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Ä–∞–±–æ—Ç—ã PostgreSQL —Å–µ—Ä–≤–µ—Ä–æ–≤. –Ø–≤–ª—è–µ—Ç—Å—è —á–∞—Å—Ç—å—é –ø—Ä–æ–µ–∫—Ç–∞ [PostgreSQL Activity Monitor](https://github.com/wobujidao/PostgreSQL-Activity-Monitor).

### üéØ –ß—Ç–æ —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è:
- üìà **–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π** –∫ –∫–∞–∂–¥–æ–π –ë–î
- üíæ **–†–∞–∑–º–µ—Ä—ã –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö** (–æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Ä–∞–∑ –≤ 30 –º–∏–Ω—É—Ç)
- üîÑ **–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π** (commits)
- üíø **–°–≤–æ–±–æ–¥–Ω–æ–µ –º–µ—Å—Ç–æ –Ω–∞ –¥–∏—Å–∫–µ**
- üìÖ **–î–∞—Ç—ã —Å–æ–∑–¥–∞–Ω–∏—è –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö**
- üîë **OID –±–∞–∑** –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–π

## üöÄ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–±–æ—Ä —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∫–∞–∂–¥—ã–µ 10 –º–∏–Ω—É—Ç
- ‚úÖ –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–æ–≤ –ë–î (—Ä–∞–∑ –≤ 30 –º–∏–Ω—É—Ç)
- ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ (lock-—Ñ–∞–π–ª)
- ‚úÖ –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –ë–î –ø–æ OID
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö (—Å—Ç–∞—Ä—à–µ 1 –≥–æ–¥–∞)
- ‚úÖ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤—Å–µ—Ö –ë–î –≤–∫–ª—é—á–∞—è —Å–∏—Å—Ç–µ–º–Ω—ã–µ (postgres, stats_db)
- ‚úÖ –ü–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å —Ä–æ—Ç–∞—Ü–∏–µ–π

## üì¶ –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### üîß create_stats_db.sh (v2.1)
–°–∫—Ä–∏–ø—Ç –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ë–î:
- –°–æ–∑–¥–∞—ë—Ç –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö `stats_db`
- –°–æ–∑–¥–∞—ë—Ç —Ç–∞–±–ª–∏—Ü—ã `pg_statistics` –∏ `db_creation`
- –î–æ–±–∞–≤–ª—è–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∏–Ω–¥–µ–∫—Å—ã
- –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ç–∞–±–ª–∏—Ü

### üìä stats_collection.sh (v2.0)
–û—Å–Ω–æ–≤–Ω–æ–π —Å–∫—Ä–∏–ø—Ç —Å–±–æ—Ä–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:
- –°–æ–±–∏—Ä–∞–µ—Ç –º–µ—Ç—Ä–∏–∫–∏ –∫–∞–∂–¥—ã–µ 10 –º–∏–Ω—É—Ç
- –û–±–Ω–æ–≤–ª—è–µ—Ç —Ä–∞–∑–º–µ—Ä—ã –ë–î –∫–∞–∂–¥—ã–µ 30 –º–∏–Ω—É—Ç
- –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –Ω–æ–≤—ã–µ –∏ —É–¥–∞–ª—ë–Ω–Ω—ã–µ –ë–î
- –í–µ–¥—ë—Ç –ª–æ–≥ –æ–ø–µ—Ä–∞—Ü–∏–π

## üõ† –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

- üêß **–û–°**: Linux (—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–ª–æ—Å—å –Ω–∞ Astra Linux 1.7, Ubuntu)
- üêò **PostgreSQL**: 14+ (–≤–æ–∑–º–æ–∂–Ω–∞ —Ä–∞–±–æ—Ç–∞ –Ω–∞ –±–æ–ª–µ–µ —Ä–∞–Ω–Ω–∏—Ö –≤–µ—Ä—Å–∏—è—Ö)
- üîê **–î–æ—Å—Ç—É–ø**: –ó–∞–ø—É—Å–∫ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è `postgres`
- üìÅ **–ü—Ä–∞–≤–∞**: –ó–∞–ø–∏—Å—å –≤ `/tmp` –∏ `/var/log`

## üì• –£—Å—Ç–∞–Ω–æ–≤–∫–∞

### 1Ô∏è‚É£ –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è

```bash
git clone https://github.com/wobujidao/PostgreSQL-Activity-Monitor.git
cd PostgreSQL-Activity-Monitor/stats_db
```

### 2Ô∏è‚É£ –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–æ–≤

```bash
# –ö–æ–ø–∏—Ä—É–µ–º —Å–∫—Ä–∏–ø—Ç—ã –≤ —Å–∏—Å—Ç–µ–º–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
sudo cp create_stats_db.sh stats_collection.sh /usr/local/bin/
sudo chmod +x /usr/local/bin/create_stats_db.sh
sudo chmod +x /usr/local/bin/stats_collection.sh
```

### 3Ô∏è‚É£ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

```bash
# –ó–∞–ø—É—Å–∫–∞–µ–º –æ—Ç –∏–º–µ–Ω–∏ postgres
sudo -u postgres /usr/local/bin/create_stats_db.sh
```

–í—ã —É–≤–∏–¥–∏—Ç–µ –ø–æ–¥—Ä–æ–±–Ω—ã–π –≤—ã–≤–æ–¥:
```
=== –ù–∞—á–∞–ª–æ —Ä–∞–±–æ—Ç—ã —Å–∫—Ä–∏–ø—Ç–∞ create_stats_db.sh ===
–í–µ—Ä—Å–∏—è: 2.1 –æ—Ç 2025-05-31

[1/5] –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ PostgreSQL...
‚úì –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ

[2/5] –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö 'stats_db'...
‚úì –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Å–æ–∑–¥–∞–Ω–∞

[3/5] –°–æ–∑–¥–∞—ë–º/–ø—Ä–æ–≤–µ—Ä—è–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã...
‚úì –¢–∞–±–ª–∏—Ü—ã –∏ –∏–Ω–¥–µ–∫—Å—ã —Å–æ–∑–¥–∞–Ω—ã

[4/5] –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ç–∞–±–ª–∏—Ü—ã db_creation...
‚úì –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü—ã –æ–±–Ω–æ–≤–ª–µ–Ω–∞

[5/5] –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç...
  - –ó–∞–ø–∏—Å–µ–π –≤ pg_statistics: 0
  - –ó–∞–ø–∏—Å–µ–π –≤ db_creation: 0

=== –°–∫—Ä–∏–ø—Ç –∑–∞–≤–µ—Ä—à—ë–Ω —É—Å–ø–µ—à–Ω–æ ===
```

### 4Ô∏è‚É£ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ cron –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–±–æ—Ä–∞

```bash
# –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º crontab –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è postgres
sudo crontab -u postgres -e

# –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫—É –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –∫–∞–∂–¥—ã–µ 10 –º–∏–Ω—É—Ç:
*/10 * * * * /usr/local/bin/stats_collection.sh
```

### 5Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã

```bash
# –ó–∞–ø—É—Å–∫–∞–µ–º —Å–±–æ—Ä —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –≤—Ä—É—á–Ω—É—é
sudo -u postgres /usr/local/bin/stats_collection.sh

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥
sudo tail -f /var/log/pg_stats.log

# –°–º–æ—Ç—Ä–∏–º —Å–æ–±—Ä–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
sudo -u postgres psql -d stats_db -c "
  SELECT datname, ts, numbackends, db_size 
  FROM pg_statistics 
  ORDER BY ts DESC 
  LIMIT 10;"
```

## üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

### –¢–∞–±–ª–∏—Ü–∞ `pg_statistics`
| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|----------|
| id | serial | –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä |
| ts | timestamptz | –í—Ä–µ–º—è —Å–±–æ—Ä–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ |
| datname | text | –ò–º—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö |
| numbackends | integer | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π |
| xact_commit | bigint | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π |
| db_size | bigint | –†–∞–∑–º–µ—Ä –ë–î –≤ –±–∞–π—Ç–∞—Ö |
| disk_free_space | bigint | –°–≤–æ–±–æ–¥–Ω–æ–µ –º–µ—Å—Ç–æ –Ω–∞ –¥–∏—Å–∫–µ |
| last_size_update | timestamptz | –í—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ |

### –¢–∞–±–ª–∏—Ü–∞ `db_creation`
| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|----------|
| datname | text | –ò–º—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (PRIMARY KEY) |
| creation_time | timestamptz | –í—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è –ë–î |
| oid | oid | OID –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö |

## üîç –ü—Ä–∏–º–µ—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤

### –ü–æ—Å–ª–µ–¥–Ω—è—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –≤—Å–µ–º –ë–î
```sql
SELECT DISTINCT ON (datname) 
  datname, ts, numbackends, 
  pg_size_pretty(db_size) as size
FROM pg_statistics 
ORDER BY datname, ts DESC;
```

### –ò—Å—Ç–æ—Ä–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á–∞—Å–∞
```sql
SELECT 
  date_trunc('hour', ts) as hour,
  datname,
  AVG(numbackends) as avg_connections
FROM pg_statistics 
WHERE ts > now() - interval '24 hours'
GROUP BY hour, datname
ORDER BY hour, datname;
```

### –¢–æ–ø-10 –ë–î –ø–æ —Ä–∞–∑–º–µ—Ä—É
```sql
SELECT 
  datname,
  pg_size_pretty(db_size) as size,
  last_size_update
FROM pg_statistics
WHERE (datname, ts) IN (
  SELECT datname, MAX(ts) 
  FROM pg_statistics 
  WHERE db_size IS NOT NULL
  GROUP BY datname
)
ORDER BY db_size DESC NULLS LAST
LIMIT 10;
```

## üêõ –†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º

### –û—à–∏–±–∫–∞ "–û—Ç–∫–∞–∑–∞–Ω–æ –≤ –¥–æ—Å—Ç—É–ø–µ" –¥–ª—è lock-—Ñ–∞–π–ª–∞
```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ –Ω–∞ /tmp
ls -la /tmp/pg_stats_collection.lock

# –£–¥–∞–ª–∏—Ç–µ —Å—Ç–∞—Ä—ã–π lock-—Ñ–∞–π–ª –µ—Å–ª–∏ –ø—Ä–æ—Ü–µ—Å—Å –Ω–µ –∑–∞–ø—É—â–µ–Ω
sudo rm -f /tmp/pg_stats_collection.lock
```

### –°–∫—Ä–∏–ø—Ç –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –¥–æ–ª–≥–æ
–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ OID –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –≤—Ä–µ–º—è –ø—Ä–∏ –±–æ–ª—å—à–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –ë–î. –≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ.

### –ù–µ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è —Ä–∞–∑–º–µ—Ä—ã –ë–î
–†–∞–∑–º–µ—Ä—ã –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è —Ä–∞–∑ –≤ 30 –º–∏–Ω—É—Ç. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:
```sql
SELECT datname, MAX(last_size_update) 
FROM pg_statistics 
WHERE last_size_update IS NOT NULL 
GROUP BY datname;
```

## üìà –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

–î–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–æ–±—Ä–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ–µ–∫—Ç [PostgreSQL Activity Monitor](https://github.com/wobujidao/PostgreSQL-Activity-Monitor) —Å –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º.

## ü§ù –í–∫–ª–∞–¥ –≤ –ø—Ä–æ–µ–∫—Ç

–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é—Ç—Å—è –ª—é–±—ã–µ —É–ª—É—á—à–µ–Ω–∏—è! –ü–æ–∂–∞–ª—É–π—Å—Ç–∞:

1. –§–æ—Ä–∫–Ω–∏—Ç–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
2. –°–æ–∑–¥–∞–π—Ç–µ –≤–µ—Ç–∫—É –¥–ª—è –≤–∞—à–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π
3. –í–Ω–µ—Å–∏—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ
4. –°–æ–∑–¥–∞–π—Ç–µ Pull Request

## üìù –õ–∏—Ü–µ–Ω–∑–∏—è

–ü—Ä–æ–µ–∫—Ç —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—è–µ—Ç—Å—è –ø–æ–¥ –ª–∏—Ü–µ–Ω–∑–∏–µ–π MIT. –°–º. —Ñ–∞–π–ª [LICENSE](../LICENSE).

## üë®‚Äüíª –ê–≤—Ç–æ—Ä

**Demidov V.E.**
- GitHub: [@wobujidao](https://github.com/wobujidao)

---

‚≠ê –ï—Å–ª–∏ –ø—Ä–æ–µ–∫—Ç –±—ã–ª –ø–æ–ª–µ–∑–µ–Ω, –ø–æ—Å—Ç–∞–≤—å—Ç–µ –∑–≤–µ–∑–¥—É –Ω–∞ GitHub!