# PostgreSQL Stats Collector

Проект для подготовки базы данных и сбора статистики PostgreSQL. Данный проект состоит из двух основных скриптов:
- **create_stats_db.sh** — создание базы данных и таблицы для хранения статистики.
- **stats_collection.sh** — сбор статистики из PostgreSQL и её запись в базу.

## Описание проекта

Этот проект предназначен для сбора и хранения базовой статистики по работе PostgreSQL. Он собирает следующие данные:
- **Число активных подключений** (numbackends)
- **Число выполненных коммитов** (xact_commit)
- **Размер базы данных** (db_size, обновляется раз в 30 минут)
- **Свободное место на диске** (disk_free_space), где расположена база данных

Скрипты снабжены подробными комментариями для понимания назначения каждого параметра.

## Требования

- **Операционная система:** Astra Linux 1.7
- **PostgreSQL:** версия 14 (или совместимая)
- **Shell:** Bash

## Компоненты проекта

### create_stats_db.sh

Скрипт выполняет следующие действия:
- Проверяет подключение к PostgreSQL.
- Создаёт базу данных `stats_db`, если она не существует.
- Создаёт таблицу `pg_statistics` с комментариями к каждому полю:
  - `id serial PRIMARY KEY` — уникальный идентификатор записи.
  - `ts timestamptz NOT NULL` — время сбора статистики.
  - `datname text NOT NULL` — имя базы данных.
  - `numbackends integer` — число активных подключений.
  - `xact_commit bigint` — число выполненных коммитов.
  - `db_size bigint` — размер базы данных (в байтах), обновляется раз в 30 минут.
  - `disk_free_space bigint` — свободное место на диске, где расположена база (в байтах).
  - `last_size_update timestamptz` — время последнего обновления размера базы.

### stats_collection.sh

Скрипт выполняет следующие действия:
- Определяет путь к каталогу данных PostgreSQL через запрос `SHOW data_directory;` (если путь не указан вручную).
- Вычисляет свободное место на диске, где находится каталог данных.
- Собирает статистику из представления `pg_stat_database` и вставляет в таблицу `pg_statistics` только необходимые поля:
  - Время сбора статистики (`ts`)
  - Имя базы данных (`datname`)
  - Число активных подключений (`numbackends`)
  - Число выполненных коммитов (`xact_commit`)
  - Свободное место на диске (`disk_free_space`)
- Удаляет записи старше одного года.
- **Обновление `db_size` производится раз в 30 минут**, даже если скрипт запускается каждые 10 минут.

## Установка и настройка

1. **Клонирование репозитория:**
   ```bash
   git clone https://gitlab.cbmo.mosreg.ru/DemidovVE/stats_db
   cd stats_db
   ```
2. **Настройка прав доступа:**
   Сделайте скрипты исполняемыми:
   ```bash
   chmod +x create_stats_db.sh stats_collection.sh
   ```
3. **Инициализация базы данных:**
   Запустите скрипт для создания базы данных и таблицы:
   ```bash
   ./create_stats_db.sh
   ```
4. **Настройка сбора статистики:**
   Добавьте в `cron` задание для регулярного сбора статистики:
   ```cron
   */10 * * * * /usr/local/bin/stats_collection.sh
   ```

## Будущие улучшения

- Расширение логирования и обработки ошибок.
- Добавление дополнительных метрик по мере необходимости.
- Оптимизация логики обновления размеров базы данных.